# chapter 6. 도커 볼륨을 이용한 퍼시스턴트 스토리지

컨테이너는 무상태 애플리케이션에게는 최적의 실행 환경이다.

> 무상태 애플리케이션이란 한 세션에서 생성된 클라이언트 데이터를 해당 클라이언트의 다음 세션에서 사용하기 위해 저장하지 않는 애플리케이션을 의미한다.
>
> 매 세션은 마치 처음인 것 처럼 수행되며 응답은 이전 세션의 데이터에 의존하지 않는다.
>
> 반대로, 상태 애플리케이션은 각 클라이언트 세션에 대한 데이터를 저장하고 다음 번에 클라이언트가 요청할 때 해당 데이터를 사용한다.
>
> 무상태 애플리케이션은 서버가 클라이언트 세션에 대한 데이터나 기타 정보를 저장하지 않는다. 대신 세션 데이터는 클라이언트에 저장되어 필요에 따라 서버로 전송한다.
>
> 무상태성은 애플리케이션의 오프라인 가동을 염두에 둘 때 고려해야 할 중요한 요소이다.
>
> 인터넷에 연결할 수 없는 경우 세션 데이터가 사용자 디바이스에 로컬에 저장했다가 다시 연결이 가능해지면 클라우드에 업로드와 복제를 수행한다.
>
> 특히, 무상태성 애플리케이션은 장애가 발생한 경우 쉽게 다시 배포할 수 있으며 워크로드의 변화에 따라 손쉽게 확장할 수 있어, 이러한 이유로 분산 아키텍처와 수평적 확장에 대한 관심이 높아지고 있다.
>
> 또한, API를 통해 다른 애플리케이션과 연결하는 데도 매우 용이하다.

## 6.1 컨테이너 속 데이터가 사라지는 이유

모든 컨테이너가 공유하는 이미지 레이어는 읽기 전용이고, 각 컨테이너가 따로 갖는 기록 가능 레이어는 컨테이너와 같은 생애주기를 갖는다.

이미지 레이어는 이미지를 내려받은 순간부터 삭제할 때까지 로컬 컴퓨터의 이미지 레이어에 존재한다.

그러나 컨테이너의 쓰기 가능 레이어는 컨테이너를 실행할 때 생성되며 컨테이너를 삭제할 때 함께 삭제된다(컨테이너를 종료하는 것만으로는 컨테이너가 삭제되지 않는다. 그래서 종료된 컨테이너의 데이터도 그대로 남아있는
것이다).

도커는 기록 중 복사(copy-on-write)라는 방법을 사용해 읽기 전용 레이어의 파일을 수정할 수 있다.

컨테이너에서 이미지 레이어에 포함된 파일을 수정하려 하면, 먼저 도커가 이 파일을 쓰기 가능 레이어로 복사해 온 다음 쓰기 가능 레이어에서 파일을 수정한다.

컨테이너 속 파일을 수정하면 컨테이너의 동작에 영향을 미친다.

컨테이너 파일 시스템은 컨테이너와 같은 생애주기를 갖는다. 컨테이너로 데이터베이스를 실행해 사용할 때, 매번 데이터가 삭제되어 있는 것을 방지할 수 있다.

도커 볼륨(Docker volume)과 마운트(mount)를 사용하면 컨테이너의 데이터를 컨테이너와 분리된 볼륨에 저장할 수 있다.

## 6.2 도커 볼륨을 사용하는 컨테이너 실행하기

도커 볼륨은 도커에서 스토리지를 다루는 단위이다.

컨테이너에서 볼륨을 사용하는 방법은 1. 수동으로 직접 볼륨을 생성하여 컨테이너에 연결, 2. Dockerfile 스크립트에서 VOLUME 인스트랙션을 사용이 있다.

```Docker
FROM [이미지 이름]:[태그]
WORKDIR [작업 디렉터리 경로]
ENTRYPOINT [실행 파일 경로]

VOLUME [컨테이너 경로]
COPY [호스트 경로] [컨테이너 경로] 

[//]: # COPY 옵션: --from=<소스 이미지 이름>[:<태그>]
```

애플리케이션 컨테이너는 자신만이 접근할 수 있는 파일을 필요로 하고, 이러한 파일을 다른 컨테이너가 동시에 접근하게 허용하면 애플리케이션이 비정상적으로 동작할 수도 있다.

볼륨은 컨테이너 간 파일 공유보다는 업데이트 간 상태를 보존하기 위한 용도로 사용하고, 이미지에서 정의하는 것보다는 명시적으로 관리하는 편이 더 낫다.

볼륨에 이름을 붙여 생성하고 업데이트 시 다른 컨테이너로 옮겨 연결한다.

## 6.3 파일 시스템 마운트를 사용하는 컨테이너 실행하기

볼룸의 장점은 컨테이너와 스토리지의 생애주기를 분리하면서도 도커를 사용하는 방식 그대로 스토리지를 다룰 수 있다.

호스트의 스토리지를 컨테이너에 좀 더 직접적으로 연결하는 수단이 바로 바인드 마운트(bind mount)이다.

바인드 마운트는 호스트 컴퓨터 파일 시스템의 디렉터리를 컨테이너 파일 시스템의 디렉터리로 만든다.

바인드 마운트는 양방향으로 동작한다.

컨테이너에서 만든 파일을 호스트 컴퓨터에서 수정할 수도 있고, 반대로 호스트에서 만든 파일도 컨테이너에서 수정할 수 있다.

## 6.4 파일 시스템 마운트의 한계점

파일 시스템 마운트를 사용할 때 다시 보면 좋을 것 같다.

본인의 상태가 각각의 시나리오에 해당하는지를 체크하기.

## 6.5 컨테이너의 파일 시스템은 어떻게 만들어지는가?

모든 컨테이너는 도커가 다양한 출처로부터 모아 만든 단일 가상 디스크로 구성된 파일 시스템을 갖는다. 이를 유니언 파일 시스템(union file system)이라고 한다.

컨테이너 스토리지의 일반적인 구조는 다음과 같다.

- 기록 가능 레이어: 비용이 비싼 계산이나 네트워크를 필요로 하는 작업을 수행하는 컨테이너의 파일 시스템. 컨테이너가 삭제되면 함께 삭제된다.
- 로컬 바인드 마운트: 호스트 컴퓨터와 컨테이너 간 데이터를 공유하기 위해 사용.
- 분산 바인드 마운트: 네트워크 스토리지와 컨테이너 간에 데이터를 공유하기 위해 사용. 읽기 전용으로 설정 파일을 전달하거나 공유 캐시로 활용 가능. 동일 네트워크상의 모든 컨테이너나 컴퓨터와 데이터를 공유하는데 적합.
- 볼륨 마운트: 컨테이너와 도커 객체인 볼륨 간에 데이터를 공유하기 위해 사용. 볼륨은 컨테이너와 독립적으로 생애주기를 갖는다.
- 이미지 레이어: 컨테이너의 초기 파일 시스템을 구성. 읽기 전용이며 후속 레이어가 이전 레이어의 내용과 겹치는 경우 이전 레이어의 내용을 덮어쓴다.




