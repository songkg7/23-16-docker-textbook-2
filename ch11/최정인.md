---
marp: true
---

## 11장 도커와 도커 컴포즈를 이용한 애플리케이션 빌드 및 테스트
11.1 도커를 이용한 지속적 통합 절차
11.2 도커를 이용한 빌드 인프라스트럭쳐 구축하기
11.3 도커 컴포즈를 이용한 빌드 설정
11.4 도커 외의 의존 모듈이 불필요한 CI 작업 만들기
11.5 CI 파이프라인에 관계된 컨테이너

---
### 지속적 통합(CI, Continuous Intgration)
**정기적으로 반복되며 애플리케이션을 빌드하고 일련의 테스트를 수행하는 절차.**
`CI 작업의 결과가 성공한다는 것은?` (현재 애플리케이션 코드 사애가 정상 + 패키징이 끝나 릴리스 후보로 배포될 준비가 된 상태) 라는 것을 의미

`CI 서버를 설치하고 관리하는 작업` 시간 소모가 크고 관리가 어렵다. 
(Why) 프로그래밍 언어와 빌드 프레임워크 조합 등의 기술스택에 따라 구축해야 하는 파이프라인이 달라짐. 

---

### 도커를 이용한 CI의 장점
CI 절차의 일관성을 유지해줌

### 도커 프로젝트의 전형적 CI 파이프라인
```
(1) CI 절차 실행됨 - (2) 빌드 단계 - (3) 테스트 단계 - (4) 배포 단계
```

`(1) CI 절차 실행됨`  CI 서버가 최신 상태의 코드를 받아오는 단계. 
Trigger? 개발자가 코드를 변경하거나, 정해진 시간이 되었을 때.

`(2) 빌드 단계` 도커 이미지를 빌드하는 단계
빌드, 테스트, 패키징, 배포를 위해 레지스트리에 푸시까지 마친 최신 코드를 반영한 이미지.

`(3) 테스트 단계 ` 컨테이너를 실행하는 단계

`(4) 배포 단계` 레지스트리에 이미지를 푸시하는 단계

---

### 빌드 인프라스트럭쳐의 필요성
CI서버에서 수행되는 1단계 외에는 모두 컨테이너 안에서 일어남. 
**하지만 전체 CI 파이프라인을 관리하려면, (1) 중앙 집권적인 형상 관리 시스템 + (2) 이미지를 저장할 도커 레지스트리 + (3) CI 작업을 수행할 자동화 서버 등의 인프라 요소가 필요함.**
(SOLUTION) 깃헙 + azure 데브옵스 + 도커 허브 / 깃랩 / 도커 컨테이너

### 도커를 이용한 빌드 인프라스트럭쳐 구축하기
`직접 구축해보면 좋은 이유?` 보안, 속도 등의 장점. 내부 네트워크 밖으로 소스코드와 패키징된 이미지를 반출하기 꺼려지는 상황에서 해결책이 됨. 인터넷 회선이 다운된 상황 대비할 수 있음.

(1) 중앙 집권적인 형상 관리 시스템 `Gogs` (오픈소스 깃 서버)
(2) 이미지를 저장할 도커 레지스트리 `오픈소스 도커 레지스트리`
(3) CI 작업을 수행할 자동화 서버 `Jenkins`

---

### 도커 컴포즈를 이용한 빌드 설정

`${REGISTRY:-docker.io}` 환경변수 REGISTRY 값으로 치환하되, 해당 환경변수가 정의되어 있지 않다면 기본값으로 docker.io를 사용해라. 
**기본값의 활용?** CI파이프라인 뿐만 아니라 다른 워크플로를 적용하게 하기 용이하기 위해. CI 서버 외의 곳에서 빌드를 실행하더라도 빌드를 성공시킬 수 있다.

`ARG` 환경변수 값 지정 - 이미지를 빌드하는 시점에만 유효하다는 점에서 `ENV` 인스트럭션과 다름.
`LABEL` Dockerfile 스크리브에 정의된 키-값 쌍을 빌드되는 이미지에 적용해줌

docker-compose.yml에서도 `context` (도커가 빌드 중에 사용할 작업 디렉터리 경로), `dockerfile` (Dockerfile 스크립트의 경로), `args` (빌드 시에 전달할 인자) 등을 지정할 수 있다. 

### 보안 검사 및 이미지에 디지털 서명을 넣는 컨테이너가 추가된 CI 파이프라인
```
(1) CI 절차 - (2) 빌드 - (3) 테스트 - (4) 사내 배포 - (5) 이미지 검증 - (6) 이미지 사이닝 - (7) 일반 배포
```
`(5)이미지 검증`  취약점 탐지 및 보안정책 준수 확인 /`(6)이미지 사이닝` 이미지에 디지털 서명 추가

