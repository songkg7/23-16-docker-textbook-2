# 12. 오케스트레이션: 도커 스웜
- 대량의 트래픽 처리
- 고가용성을 얻기위한 여러대의 호스트 구성해서 운영환경
- 오케스트레이션 툴 - 도커 스웜, 쿠버네티스

## 12.1 컨테이너 오케스트레이션 도구란?
- 클러스터를 구성하는 여러대의 호스트 컴퓨터
- 컨테이너 관리, 서비스 작업을 분산, 트래픽 분산, 불량한 컨테이너 교체의 역할
- 도커 설치 -> 클러스터 등록
- 클러스터에는 모든 정보가 담긴 분산 데이터 베이스와 어떤 컨테이너를 실행할지 배정하는 스케줄러, 클러스터를 구성하는 호스트 간에 연락 시스템
- 컨테이너 관리를 모두 도구가 대신해준다.
- 네트워크(dns, 표준 네트워크 프로토콜),비밀값 애플리케이션 설정, 데이터 저장 역할
- 클러스터 API, INGRESS 공개 엔드포인트, 서비스로 이루어진다.

## 12.2 도커 스웜으로 클러스터 만들기
- 스웜 모드로 전환해서 초기화
- `docker swarm init`
- 역할은 매니저, 워커
- 매니저는 클러스터 관리 작업 수행(클러스터 DB, yaml 파일 전달 api, 컨테이너 모니터링, 스케줄링)
- `docker swarm join-token worker` -> 워커로
- `docker swarm join-token manager` -> 매니저로 
- `docker node ls` -> 스웜에 참여중인 노드

## 12.3 스웜 서비스로 애플리케이션 실행하기
- 서비스를 배포하면 스웜이 대신 컨테이너를 실행 (서비스는 컨테이너의 추상화)
- 사용되는 이미지, 환경 변수와 값, 포트, 여러개의 레플리카로 사용됨
- 서비스를 구성하는 컨테이너는 replica
- docker service ps timececk -> 레플리카 목록 확인
- docker container ls 현재 컴퓨터의 컨테이너들
- docker container rm -f 가장 최근의 컨테이너 삭제
- 삭제하면 알아서 replica를 실행시켜 준다.
- 서비스 업데이트 시
  - rolling update로 컨테이너 하나씩 교체해 나간다.
    - 신버전 컨테이너에 문제가 있으면 자동 중단한다.
    - 자동 롤백시킨다.
- `docker service update --rollback timecheck`
- `docker service ps timecheck`
- `docker service update --rollback timecheck`

## 12.4 클러스터 환경에서 트래픽 관리하기
- 컴포넌트는 도메인 네임으로 서로 식별
- 도커 dns 서버가 도메인 네임을 조회해 ip 알려주면 ip 주소로 트래픽 전달
- 트래픽은 컨테이너에 전달되고 컨테이너가 응답
- 스웜 모드에서는 오버레이 네트워크 생성해서 사용 가능하다.
- 개별의 오버레이 속한 서비스들은 서로 통신 x
- 오버레이에서는 컨테이너의 ip로 응답하지 않고 서비스를 가르키는 가상 ip 사용한다.
- 해당 서비스 ip는 해당 서비스의 모든 replicas 들이 공유하는 가상 ip로 생각하면된다.
- VIP 네트워크를 사용해서 네트워크 계층에서 Load Balancing 해준다.
- 한노드에서 실행중인 여러개의 컨테이너도 ingress NETWORKING(도커 엔진) 가 LB 해준다. 

## 12.5 스웜과 쿠버네티스 중 무엇을 사용할까?
- 스웜이 쿠버네티스보다 배우기 쉽다 ~~ 결국 쿠버네티스 하기전에 써봐요~ 라는 내용

## 12.6 연습 문제
