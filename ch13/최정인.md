---
marp: true
---

## 13장 도커 스웜 어택으로 분산 애플리케이션 배포하기
13.1 도커 컴포즈를 사용한 운영 환경
13.2 컨피그 객체를 이용한 설정값 관리
13.3 비밀값을 이용한 대외비 설정 정보 관리하기
13.4 스웜에서 볼륨 사용하기
13.5 클러스터는 스택을 어떻게 관리하는가

---

### 도커 컴포즈를 사용한 운영환경
운영환경에서는 명령행 도구를 사용하는 대신, 애플리케이션의 구성요소 및 원하는 상태를 YAML 파일에 기술한 뒤, 매니저 노드에 이 YAML 파일을 전달한다. 

## 스택
- 도커 스웜의 리소스 
  - 도커 명령행 도구를 이용해서 생성하고 목록을 확인하거나 삭제할 수 있음
- 서비스, 네트워크, 볼륨 등 여러 개의 도커 리소스를 묶어 만든 리소스
- 스웜 모드의 일급 리소스
- 애플리케이션을 관리하는 단위

```
docker stack deploy -c {컴포즈 파일} {스택 이름} # 컴포즈 파일로 스택 배포하기
docker stack ls # 스택 목록 확인하기
```

---

### 스웜 배포 설정 추가
- 서비스가 차지할 수 있는 컴퓨팅 리소스의 상한을 설정해둘 수 있다. 
  - 악의적인 레플리카가 노드의 리소스를 고갈시키는 것을 방지
- 이러한 상한치를 결정하려면, 애플리케이션이 최대 성능으로 동작할 때 어느 정도의 CPU/Memory를 필요로 하는지 확인해야 한다. 
```
services:
    todo-web:
        image: diamol/ch06-todo-list
        ports:
        - 8080:80
        deploy:
            replicas: 2
            resources:
                limits:
                    cpus: "0.50"
                    memory: 100M

```
---

### 스웜 스택에 업데이트 적용하기
수정된 YAML 파일을 매니저 노드에 전달하면 애플리케이션에 반영된다.
(새로운 버전의 컴포즈 파일을 전달하면, 스웜이 새로운 레플리카를 생성해서 기존 레플리카를 대체한다)
```
docker stack deploy -c {컴포즈파일} {스택이름} # 수정된 컴포즈 파일을 스웜에 전달하여 스택 배포
```
### 스웜 스택의 활용
스웜 스택은 애플리케이션을 그룹화하는 데에 사용한다.
애플리케이션 전체를 스택으로 묶어서 한번에 관리-배포/제거-할 수 있다.

---

### 컨피그 객체를 이용한 설정값 관리
운영환경에서는 스웜에 저장된 비밀값과 컨피그 객체에서 제공된 설정값이 적용되어 도커 이미지가 패키징된다.
- 도커 스웜에서 설정값을 위해 사용하는 객체. 컨테이너가 설정값을 클러스터에서 읽어올 수 있게 해주는 기능을 가진 리소스.
- 애플리케이션 배포와 설정 관리를 분리해주는 역할
- JSON, XML, key-value, binary 등 다양한 데이터 포맷을 담을 수 있디.
- 도커 스웜에 의해 컨테이너 파일 시스탬 내의 파일로서 전달된다. (마치 직접 파일을 업로드한 것과 같은 효과)
- 컨피그 객체는 보안이 적용되어 있지 않아서, 클러스터에 접근 권한이 있으면 객체의 내용을 모두 알 수 있다.
```
docker config create {컨피그객체 이름} {파일이 위치한 디렉토리} # 컨피그 객체 생성하기
docker config ls # 컨피그 객체의 설정값 확인하기
docker config inspect --pretty {컨피그객체 이름} # 컨피그 객체 확인하기
```

---

애플리케이션의 정의 중 컨피그 객체로부터 설정값을 도입하도록 하기
```
services:
    todo-web:
        image: diamol/ch06-todo-list
        ports:
        - 8080:80
        configs:
        - source: todo-list-config
          target: /app/config/config.json
#..
configs:
    todo-list-config:
        external: true
```
서비스의 레플리카 컨테이너가 실행되면, 컨피그 객체의 내용이 컨테이너 파일시스템의 'target'에 명시된 위치의 파일(/app/config/config.json)로 옮겨진다.
`external 플래그`를 통해 컨피그 객체의 이름을 정의하고, 해당 리소스가 이미 클러스터에 저장되어 있음을 나타낼 수 있다. 

---
### 비밀값을 이용한 대외비 설정 정보 관리하기
로컬 파일로부터 비밀값을 생성하고, 클러스터 db에 저장했다가, 서비스 정의에서 비밀값을 참조하면, 실행된 컨테이너의 파일 시스템에 비밀값이 전달되는 방식.
컨피그 객체와의 차이점: 비밀값이 컨테이너에 전달된 상태에서만 복호화된 비밀값을 볼 수 있고, 그 외의 경우에는 항상 암호화된 상태로 존재한다.

### 컨피그 객체와 비밀값은 수정이 불가능하다.
내용을 변경하려면 새로 만들어야 함.
1) 변경된 내용을 담은 새로운 컨피그 객체/비밀값을, 기존 파일과 다른 이름으로 생성
2) 컴포즈 파일에 정의된 " 이름을 변경
3) 변경된 컴포즈 파일로 스택 배포
즉 도커 스웜에선 설정값을 수정하려면 서비스를 업데이트해야하고, 컨테이너를 교체해야 함. (쿠버네티스에서는 기존의 컨피그 객체/비밀값의 수정이 가능하다.)

---

### 스웜에서 볼륨 사용하기
(reminder) `볼륨` 컨테이너와 별개의 생애주기를 갖는 스토리지 단위
컨테이너 외부에 존재하는 리소스. (즉 애플리케이션을 업데이트하면, 컨테이너만 교체되고 볼륨은 새 컨테이너에 연결된다. 새 컨테이너는 이전의 데이터를 그대로 유지한다.)

도커 스웜에서도 유사. 컴포즈 파일의 서비스 정의에 볼륨 마운트를 정의하면, 레플리카에서 볼륨을 마치 로컬 파일 시스템의 디렉터리처럼 활용할 수 있다.

(problem - 새로운 레플리카가 기존 레플리카와 다른 노드에서 실행되는 경우)
노드에 레이블을 부여해서, 서비스가 특정 노드에서만 실행되게끔 고정하면 됨.

---

## Summary
`스택` 클러스터가 관리를 담당하는 리소스의 모임

### 스택이 리소스를 관리하는 유형
- `비밀값/컨피그 객체` 외부에서 관리 가능. 애플리케이션 배포 전에 생성되고, 스택은 서비스를 이들에 연결하는 역할.
- `볼륨` 외부에서 관리 or 스택이 관리. 스택과 생애주기를 함께함 (but, 이름이 붙은 볼륨은 스택이 제거된 후에도 유지됨)
- `서비스` 스택에 종속적 (스택과 함께 생성/업데이트/제거됨)
- `인그레스 네트워크` 항상 존재함. 스택은 인그레스 네트워크에서 포트 공개 여부를 관리함