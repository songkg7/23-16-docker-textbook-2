---
marp: true
---

# 17. 도커 이미지 최적화하기 : 보안, 용량, 속도

---

* docker system df : 이미지와 컨테이너, 볼륨, 빌드 캐시 등이 점유하는 실제 디스크 용량을 알 수 있다.
    * 사용하지 않는 도커 이미지로 디스크 용량이 쉽게 잠식된다.
    * docker system prune 명령을 실행해 사용하지 않는 이미지 레이어나 빌드 캐시를 비워주는 것이 좋다. -> 이러지 않아도 이미지 최적화 문제로 해결

* 준수해야 할것
    1) 필요한 파일만 이미지에 포함시킨다.
    2) 각 레이어마다 따로 최적화해야한다.
       Dockerfile 스크립트의 인스트럭션 하나마다 이미지 레이어가 하나씩 생기고 이 이미지 레이어가 모두 합쳐져 전체 이미지가 된다. 그다음 레이어에서 파일을 지우더라도 실제로 파일 삭제가 아니다.
    3) 애플리케이션 실행에 필요하지 않은 파일은 이미지에 복사해서는 안된다.
       그 뒤에 오는 인스트럭션에서 불필요한 파일을 지웠다하더라도 이전 레이어에 그대로 남아 디스크 용량을 차지한다.
---

* 운영체제 기반 이미지의 크기가 크면 다양한 도구가 포함되어 유용하나, 컨테이너에서는 보안상  안좋다.
* 이미지에 방치한 불필요한 파일이 공격 수단으로 될 수 있다.
* 골든 이미지를 사용하여 이러한 문제를 피할 수 있다.

---
## 이미지 레이어 수와 이미지 크기는 최소한으로
1) 최소한의 크기와 보안성을 갖춘 기반 이미지
2) 꼭 필요한 것만 포함하는 이미지를 만드는 것
   -> 소프트웨어를 설치하면 패키지 목록을 캐싱하거나 추천 패키지 등을 함께 설치하기 때문에 대부분의 경우 불필요한 요소나 설치 후 잔재가 발생한다.
3) 인스트럭션을 분할해 두고 개발할 수 있지만 항상 다시 최적화를 해 두어야 한다.
4) 디스크 용량이 가장 많이 절약되는 부분은 압축파일을 삭제해서가 아니라 필요한 파일만 압축을 해제했기 때문

---
## 최적화가 중요한 이유

- 기반 이미지를 잘 고르기. 골든 이미지를 갖출 수 있는게 이상적이다.
- 아주 간단한 애플리케이션이 아니라면 멀티 스테이지 빌드를 적용한다.
- 불필요한 패키지나 파일을 포함시키지 말고, 레이어 크기를 최소한으로 유지한다.
- Dockerfile 스크립트의 인스트럭션은 자주 수정하는 순서대로 뒤에 오도록 배치해 캐시를 최대한 활용한다.