# 20. 리버스 프록시의 라우팅과 SSL 적용하기
- 외부 트래픽을 컨테이너로 이어주는 라우팅은 도커 엔진이 담당한다.
- 컨테이너가 주시할 수 있는 네트워크 포트는 하나 이다.
- 리버스 프록시의 기능과 리버스 프록시 사용 패턴을 소개한다.

## 20.1 리버스 프록시란?
- 여러 웹 애플리케이션을 통하는 관문 역할
- 모든 트래픽은 리버스 프록시를 거치며 어떤 애플리케이션에서 출발한 것인지 판단한다.
- 애플리케이션 응답에 대한 캐시 제공
- 리버스 프록시는 포트를 외부로 공개한 유일한 컨테이너다.
- 스케일링, 업데이트, 보안 면에서 유리
- 같은  포트에서 여러 개의 에플리케이션 호스팅을 위해서 domain 이름 설정 필요 -> hosts 파일에 도메인 추가
  - 도메인과 ip 주소 짝으로 설정 -> 해당 정보를 이용해서 nignx에서 요청 전달
- 브라우저 -> 로컬 pc(도메인설정됨) -> 헤더보고 HOST=whoami.local 사용해서 요청에 응답한다.
  - nginx/sites-enabled/ 에 사이트 설정파일 표기 필요하다.

## 20.2 리버스 프록시의 라우팅과 ssl 적용하기
- 모든 트래픽이 nginx를 지나가게 되고 사이트별 설정파일을 모두 읽은 다음 업스트림이 모두 접근 가능한지 확인을 거친다.
- 접근이 불가능하면 엔진엑스 종료 아니면 내부 라우팅 리스트를 만든다. + 로드 밸런싱해준다.
- HTTPS 설정을 추가하려면 설정과 인증서가 필요하다
- HTTP 로 80 번 포트로 보고 있다가 301로 443 포트를 사용하는 HTTPS로 리다이렉트한다.
SERVER {
  server_name image-gallery.local;
  listen 80;
  return 301 https://$server_name$request_uri;
}
server {
  server_name image-gallery.local;
  listen 443 ssl;
}
- 애플리케이션 마다 인증서와 키 파일 ㄹ세트가 필요하고 운영환경에서는 비밀값 형태로 사용해야한다.

## 20.3 프록시를 이용한 성능 및 신뢰성 개선
- 캐싱 프록시는 요청 처리시간을 줄인다.
- 트래픽을 줄일 수 있다.
- X-Cache 항목으로 hit이 있으면 해당 응답을 보내게 된다.
- HTTP 응답에 Gzip 압축 적용, 클라이언트 캐시헤더 추가 등으로 성능을 개선할 수 있다.
- 애플리케이션 별로 설정파일을 따로 유지하며 설정이 변경될때마다 엔진엑스를 재시작해야한다.

## 20.4 클라우드 네이티브 리버스 프록시
- 라우팅
- 로드 밸런싱
- SSL 적용
- 스티키 세션(연속적 요청 관리)
## 20.5 리버스 프록시를 활용한 패턴의 이해
- 1. 첫번째 패턴은 각각 필요한 리소스를 각각 필요한 서비스에게 요청한다
- 2. 두번째 패턴은 필요한 서비스(웹사이트)만 외부로 노출 시키고 해당 서비스가 다른 서비스들을 호출하는 방향
- 3. 모놀리식설계를 가진 컨테이너에 모든 REQUEST 전달하고 추후 추가기능들은 다른 컨테이너로 호출한다.

